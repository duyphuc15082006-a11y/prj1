<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Level Detail</title>
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
  <header>
    <div class="brand">Vocab Levels</div>
    <nav>
      <span>Xin chào, <strong data-auth-status>Guest</strong></span>
      <a href="/index.html">Học từ mới</a>
      <a href="/quiz.html">Làm quiz</a>
      <a href="/leaderboard.html">Leaderboard</a>
      <a href="/admin.html" data-admin-link style="display:none">Admin</a>
      <a href="/login.html" data-login-link>Login</a>
      <a href="/register.html" data-register-link>Register</a>
      <button class="btn secondary" data-logout style="display:none">Logout</button>
    </nav>
  </header>

  <main class="container">
    <section class="hero">
      <h1 id="level-title">Level</h1>
      <p>Học từng từ theo thứ tự alphabet, đánh dấu đã học để theo dõi tiến độ.</p>
      <div style="margin-top:12px;">
        <button class="btn" id="start-quiz">Làm quiz</button>
      </div>
    </section>

    <div id="vocab-card" class="card" style="max-width:520px;"></div>
    <div style="margin-top:12px; display:flex; gap:8px;">
      <button class="btn secondary" id="prev-btn">Từ trước</button>
      <button class="btn" id="next-btn">Từ tiếp</button>
      <div id="progress-info" style="margin-left:auto; color:#6f6559;"></div>
    </div>
  </main>

  <script src="/js/app.js"></script>
  <script>
    if (!App.requireAuth()) {
      throw new Error('Auth required');
    }
    App.renderHeader();
    const level = App.getQueryParam('level');
    const title = document.getElementById('level-title');
    const vocabCard = document.getElementById('vocab-card');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const progressInfo = document.getElementById('progress-info');
    const startQuiz = document.getElementById('start-quiz');
    let vocabList = [];
    let index = 0;

    title.textContent = `Level ${level}`;
    startQuiz.addEventListener('click', () => {
      window.location.href = `/quiz.html?level=${level}`;
    });

    function renderCard() {
      if (!vocabList.length) {
        vocabCard.innerHTML = '<p>Không có từ vựng.</p>';
        progressInfo.textContent = '';
        return;
      }
      const item = vocabList[index];
      vocabCard.innerHTML = `
        <div class="level-number">#${index + 1}</div>
        <div style="font-size:22px; font-weight:700;">${item.word}</div>
        <div style="color:#2d7d6f; font-weight:600;">${item.meaning}</div>
        <div style="color:#6f6559;">${item.example || ''}</div>
        <label style="margin-top:10px; display:inline-block;">
          <input type="checkbox" id="learned-toggle" ${item.is_learned ? 'checked' : ''} />
          Đã học
        </label>
      `;
      progressInfo.textContent = `${index + 1}/${vocabList.length}`;

      const toggle = document.getElementById('learned-toggle');
      toggle.addEventListener('change', async (e) => {
        try {
          await App.apiFetch(`/progress/${item.id}`, {
            method: 'PUT',
            headers: App.authHeaders(),
            body: JSON.stringify({ isLearned: e.target.checked })
          });
          item.is_learned = e.target.checked ? 1 : 0;
        } catch (err) {
          alert('Bạn cần đăng nhập để lưu tiến độ.');
          e.target.checked = !e.target.checked;
        }
      });
    }

    async function loadVocab() {
      try {
        const data = await App.apiFetch(`/vocab?level=${level}`, {
          headers: App.authHeaders()
        });
        vocabList = data;
        index = 0;
        renderCard();
      } catch (err) {
        alert(err.message);
      }
    }

    prevBtn.addEventListener('click', () => {
      if (!vocabList.length) return;
      index = Math.max(0, index - 1);
      renderCard();
    });

    nextBtn.addEventListener('click', () => {
      if (!vocabList.length) return;
      index = Math.min(vocabList.length - 1, index + 1);
      renderCard();
    });

    if (!level) {
      alert('Thiếu level');
    } else {
      loadVocab();
    }
  </script>
</body>
</html>
